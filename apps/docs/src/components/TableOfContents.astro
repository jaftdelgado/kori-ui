---
interface Props {
  headings: { depth: number; slug: string; text: string }[];
}

const { headings } = Astro.props;
const filteredHeadings = headings.filter((h) => h.depth > 1 && h.depth < 4);
---

{
  filteredHeadings.length > 0 && (
    <div class="sticky top-0">
      <h4 class="text-[10px] font-bold mb-5 text-zinc-500 uppercase tracking-[0.2em]">
        On this page
      </h4>
      <nav id="toc-nav" class="flex flex-col border-l border-zinc-900">
        {filteredHeadings.map((h) => (
          <a
            href={`#${h.slug}`}
            class:list={[
              "toc-link text-sm transition-all duration-200 border-l -ml-px py-1.5",
              {
                "pl-6 text-zinc-500 border-transparent": h.depth === 3,
                "pl-4 text-zinc-400 border-transparent": h.depth === 2,
              },
            ]}
          >
            {h.text}
          </a>
        ))}
      </nav>
    </div>
  )
}

<script>
  const observerOptions = {
    root: null,
    rootMargin: "-20px 0px -70%",
    threshold: 1.0,
  };

  const observerCallback = (entries: IntersectionObserverEntry[]) => {
    entries.forEach((entry) => {
      if (entry.isIntersecting) {
        const id = entry.target.getAttribute("id");
        if (!id) return;

        document.querySelectorAll(".toc-link").forEach((link) => {
          const isActive = link.getAttribute("href") === `#${id}`;
          link.classList.toggle("active", isActive);
        });
      }
    });
  };

  const observer = new IntersectionObserver(observerCallback, observerOptions);
  document.querySelectorAll("h2, h3").forEach((h) => observer.observe(h));
</script>

<style>
  @reference "../styles/global.css";

  .toc-link:hover,
  .toc-link.active {
    @apply text-orange-500 border-orange-500;
  }

  .toc-link.active {
    @apply font-medium;
  }
</style>